<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§æ°£è±¡ç«™</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Neumorphism Color Palette */
            --neu-bg: #EFEEEE; /* ç±³ç™½/æ·ºç°åŸºåº• */
            --neu-text-main: #5A554E; /* æ·±ç°è¤æ–‡å­— */
            --neu-text-secondary: #9A968F; /* æ¬¡è¦æ–‡å­— */
            
            /* æ ¸å¿ƒï¼šå…‰å½±è¨­å®š */
            /* äº®é¢å…‰ï¼ˆå·¦ä¸Šï¼‰ */
            --neu-shadow-light: #FFFFFF; 
            /* æš—é¢å½±ï¼ˆå³ä¸‹ï¼‰- å¸¶ä¸€é»æš–è‰²èª¿ */
            --neu-shadow-dark: #D1CDC5; 
            
            --neu-accent: #6BAED6; /* æŸ”å’Œçš„è—è‰²å¼·èª¿è‰² */
            --neu-accent-warm: #F7B267; /* æŸ”å’Œçš„æš–è‰²å¼·èª¿è‰² */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            /* é˜²æ­¢ iOS æ©¡çš®ç­‹æ•ˆæœ */
            overscroll-behavior-y: none; 
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--neu-bg);
            color: var(--neu-text-main);
            min-height: 100vh;
            /* å¢åŠ ä¸€é»ç´‹ç†è³ªæ„Ÿ */
            /* background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E"); */
        }

        /* === Neumorphism Utilities (æ ¸å¿ƒæ¨£å¼) === */
        /* å‡¸èµ·æ•ˆæœ (å¡ç‰‡, æŒ‰éˆ•) */
        .neu-flat {
            background: var(--neu-bg);
            box-shadow: 6px 6px 12px var(--neu-shadow-dark),
                        -6px -6px 12px var(--neu-shadow-light);
            border-radius: 20px;
        }
        
        /* æ›´åŠ å‡¸èµ·çš„åœ“å½¢ (å„€è¡¨ç›¤) */
        .neu-convex-circle {
            background: linear-gradient(145deg, #ffffff, #e6e5e2);
            box-shadow: 8px 8px 16px var(--neu-shadow-dark),
                        -8px -8px 16px var(--neu-shadow-light);
            border-radius: 50%;
        }

        /* å‡¹é™·æ•ˆæœ (è¼¸å…¥æ¡†, æŒ‰ä¸‹ç‹€æ…‹) */
        .neu-inset {
            background: var(--neu-bg);
            box-shadow: inset 4px 4px 8px var(--neu-shadow-dark),
                        inset -4px -4px 8px var(--neu-shadow-light);
            border-radius: 15px;
        }

        /* === Layout Structure === */
        .container {
            max-width: 480px; /* æ‰‹æ©Ÿä»‹é¢å¯¬åº¦ */
            margin: 0 auto;
            padding: 20px 25px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header & Location Selector */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-top: 10px;
        }
        
        .date-display {
            font-size: 0.9rem;
            color: var(--neu-text-secondary);
            font-weight: 500;
        }

        /* è‡ªå®šç¾©æ“¬ç‰©åŒ– Select */
        .location-select-wrapper {
            position: relative;
            width: 160px;
        }

        .location-select {
            width: 100%;
            padding: 10px 15px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--neu-text-main);
            background: var(--neu-bg);
            border: none;
            appearance: none; /* ç§»é™¤é è¨­æ¨£å¼ */
            cursor: pointer;
            outline: none;
        }
        
        /* ä¸‹æ‹‰ç®­é ­ Icon */
        .select-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--neu-text-secondary);
            font-size: 1.2rem;
        }

        /* === Main Weather Dashboard === */
        .main-dashboard {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
        }

        /* å¤§åœ“å½¢æº«åº¦è¨ˆ */
        .temp-circle {
            width: 200px;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            position: relative;
        }
        
        /* ç”¨å½å…ƒç´ åšä¸€å€‹ç´°ç·»çš„å¤–ç’°å…‰æšˆ */
        .temp-circle::after {
            content: '';
            position: absolute;
            top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%;
            box-shadow: inset 2px 2px 4px rgba(255,255,255,0.5),
                        inset -2px -2px 4px rgba(0,0,0,0.05);
            z-index: -1;
        }

        .main-icon i {
            font-size: 4rem;
            color: var(--neu-accent);
            /* è®“ icon ä¹Ÿæœ‰å¾®å¾®çš„ç«‹é«”æ„Ÿ */
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.1));
        }

        .main-temp {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1;
            margin: 5px 0;
            color: var(--neu-text-main);
        }

        .weather-desc {
            font-size: 1.1rem;
            color: var(--neu-text-secondary);
            font-weight: 500;
        }
        
        .temp-range {
             font-size: 0.9rem;
             color: var(--neu-text-secondary);
             margin-top: 5px;
        }

        /* === Detail Grid (å„€è¡¨ç›¤å€) === */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 100%;
            margin-bottom: 30px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢/åœ“å½¢ */
        }

        .detail-icon {
            font-size: 1.8rem;
            color: var(--neu-accent);
            margin-bottom: 5px;
        }
        
        /* ä¸åŒé¡å‹çš„ Icon é¡è‰²å¾®èª¿ */
        .icon-rain { color: var(--neu-accent); }
        .icon-comfort { color: var(--neu-accent-warm); }
        .icon-wind { color: var(--neu-text-secondary); }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--neu-text-secondary);
        }

        /* === Forecast Section (ç¨å¾Œé å ±) === */
        .forecast-section {
            margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-left: 5px;
        }

        .scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 10px 5px 20px 5px; /* é ç•™é™°å½±ç©ºé–“ */
            scrollbar-width: none;
        }
        .scroll-container::-webkit-scrollbar { display: none; }

        .forecast-card {
            min-width: 100px;
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }

        .forecast-time {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .forecast-icon {
            font-size: 2rem;
            color: var(--neu-accent);
            margin: 8px 0;
        }

        .forecast-temp {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Loading & Error States */
        .state-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--neu-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: var(--neu-text-secondary);
        }
        
        .loading-icon {
            font-size: 3rem;
            animation: spin 2s linear infinite;
            color: var(--neu-accent);
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Pull to refresh æç¤ºçš„æ¨£å¼è¦†è“‹ */
        .ptr--pull-down {
            color: var(--neu-text-secondary);
            font-weight: 500;
        }
    </style>
</head>

<body>

    <div id="loadingState" class="state-container">
        <i class="ph ph-spinner-gap loading-icon"></i>
        <p style="margin-top: 15px; font-weight: 500;">æ­£åœ¨åŒæ­¥æ°£å€™è³‡æ–™...</p>
    </div>
    
    <div id="errorState" class="state-container" style="display: none;">
        <i class="ph ph-cloud-slash" style="font-size: 4rem; color: var(--neu-text-secondary);"></i>
        <p id="errorMessage" style="margin-top: 15px; font-weight: 500;">é€£ç·šå¤±æ•—</p>
        <button onclick="initWeatherApp()" class="neu-flat" style="margin-top: 20px; padding: 10px 25px; border: none; font-family: inherit; font-weight: 600; color: var(--neu-accent); cursor: pointer;">é‡æ–°å˜—è©¦</button>
    </div>

    <div id="mainContent" class="container" style="visibility: hidden;"> <header class="header">
            <div id="dateDisplay" class="date-display">Loading date...</div>
            
            <div class="location-select-wrapper neu-inset">
                <select id="locationSelect" class="location-select">
                    </select>
                <i class="ph ph-caret-down select-icon"></i>
            </div>
        </header>

        <section class="main-dashboard" id="currentWeather">
            </section>

        <section class="detail-grid" id="currentDetails">
             </section>

        <section class="forecast-section">
            <h3 class="section-title">ç¨å¾Œé å ±</h3>
            <div class="scroll-container" id="forecastContainer">
                 </div>
        </section>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/pulltorefreshjs@0.1.22/dist/index.umd.min.js"></script>

    <script>
        // ================= CONFIGURATION =================
        // TODO: è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨å¾Œç«¯çš„çœŸå¯¦ç¶²å€ (ä¸åŒ…å«çµå°¾æ–œç·š)
        const API_BASE_URL = "https://hex-weather-vibecoding.zeabur.app"; // ä¾‹å¦‚: https://weather-api.zeabur.app
        const API_ENDPOINT = `${API_BASE_URL}/api/weather`;

        // å°ç£ 22 ç¸£å¸‚åˆ—è¡¨
        const TAIWAN_LOCATIONS = [
            "åŸºéš†å¸‚", "è‡ºåŒ—å¸‚", "æ–°åŒ—å¸‚", "æ¡ƒåœ’å¸‚", "æ–°ç«¹å¸‚", "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", "è‡ºä¸­å¸‚",
            "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "å˜‰ç¾©å¸‚", "å˜‰ç¾©ç¸£", "è‡ºå—å¸‚", "é«˜é›„å¸‚", "å±æ±ç¸£",
            "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "è‡ºæ±ç¸£", "æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"
        ];

        // ç°¡æ˜“ç¸£å¸‚ä¸­å¿ƒåº§æ¨™ (ç”¨æ–¼è‡ªå‹•å®šä½è¨ˆç®—æœ€è¿‘ç¸£å¸‚)
        const LOCATION_COORDS = {
            "åŸºéš†å¸‚": { lat: 25.1316, lng: 121.7447 }, "è‡ºåŒ—å¸‚": { lat: 25.0375, lng: 121.5637 },
            "æ–°åŒ—å¸‚": { lat: 25.0124, lng: 121.4657 }, "æ¡ƒåœ’å¸‚": { lat: 24.9889, lng: 121.3135 },
            "æ–°ç«¹å¸‚": { lat: 24.8036, lng: 120.9686 }, "æ–°ç«¹ç¸£": { lat: 24.8421, lng: 121.0135 },
            "è‹—æ —ç¸£": { lat: 24.5648, lng: 120.8207 }, "è‡ºä¸­å¸‚": { lat: 24.1618, lng: 120.6468 },
            "å½°åŒ–ç¸£": { lat: 24.0518, lng: 120.5161 }, "å—æŠ•ç¸£": { lat: 23.9028, lng: 120.6904 },
            "é›²æ—ç¸£": { lat: 23.7080, lng: 120.4313 }, "å˜‰ç¾©å¸‚": { lat: 23.4812, lng: 120.4535 },
            "å˜‰ç¾©ç¸£": { lat: 23.5089, lng: 120.5846 }, "è‡ºå—å¸‚": { lat: 22.9977, lng: 120.2192 },
            "é«˜é›„å¸‚": { lat: 22.6237, lng: 120.3120 }, "å±æ±ç¸£": { lat: 22.6697, lng: 120.4861 },
            "å®œè˜­ç¸£": { lat: 24.7021, lng: 121.7377 }, "èŠ±è“®ç¸£": { lat: 23.9914, lng: 121.6098 },
            "è‡ºæ±ç¸£": { lat: 22.7563, lng: 121.1427 }, "æ¾æ¹–ç¸£": { lat: 23.5697, lng: 119.5794 },
            "é‡‘é–€ç¸£": { lat: 24.4493, lng: 118.3766 }, "é€£æ±Ÿç¸£": { lat: 26.1505, lng: 119.9265 }
        };

        // é è¨­åœ°é»
        let currentLocation = "è‡ºåŒ—å¸‚"; 

        // ================= HELPER FUNCTIONS =================

        // 1. åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
        function populateDropdown() {
            const select = document.getElementById('locationSelect');
            TAIWAN_LOCATIONS.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                select.appendChild(option);
            });
            select.value = currentLocation; // è¨­å®šåˆå§‹å€¼

            // ç¶å®šåˆ‡æ›äº‹ä»¶
            select.addEventListener('change', (e) => {
                currentLocation = e.target.value;
                fetchWeather(currentLocation);
            });
        }

        // 2. æ›´æ–°æ—¥æœŸé¡¯ç¤º
        function updateDateDisplay() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const dayIndex = now.getDay();
            const days = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
            document.getElementById('dateDisplay').textContent = `${month}æœˆ${date}æ—¥ ${days[dayIndex]}`;
        }

        // 3. å¤©æ°£ç‹€æ³å°æ‡‰ Phosphor Icon Class (éœ€è¦æ ¹æ“š CWA çš„ Wx æè¿°èª¿æ•´)
        function getWeatherIconClass(weatherText) {
            if (!weatherText) return "ph-question";
            // ç°¡åŒ–åˆ¤æ–·é‚è¼¯ï¼Œè¶Šä¸Šé¢çš„è¶Šå„ªå…ˆåŒ¹é…
            if (weatherText.includes("é›·")) return "ph-cloud-lightning";
            if (weatherText.includes("é›¨")) return "ph-cloud-rain";
            if (weatherText.includes("é™°")) return "ph-cloud";
            if (weatherText.includes("å¤šé›²") && weatherText.includes("æ™´")) return "ph-cloud-sun";
            if (weatherText.includes("å¤šé›²")) return "ph-cloud";
            if (weatherText.includes("æ™´")) return "ph-sun";
            return "ph-cloud-sun"; // é è¨­
        }

        // 4. æ ¼å¼åŒ–æ™‚é–“å€æ®µé¡¯ç¤º (ä¾‹å¦‚: æ™šä¸Šã€æ˜å¤©æ—©æ™¨)
        function formatTimePeriod(startTime) {
            const date = new Date(startTime);
            const today = new Date();
            const hour = date.getHours();
            
            let period = "";
            if (hour >= 5 && hour < 11) period = "æ—©æ™¨";
            else if (hour >= 11 && hour < 14) period = "ä¸­åˆ";
            else if (hour >= 14 && hour < 18) period = "ä¸‹åˆ";
            else if (hour >= 18 && hour < 23) period = "æ™šä¸Š";
            else period = "æ·±å¤œ";

            // ç°¡å–®åˆ¤æ–·æ˜¯å¦ç‚ºæ˜å¤© (è·¨æ—¥)
            if (date.getDate() !== today.getDate()) {
                return "æ˜å¤©" + period;
            }
            return period;
        }

        // 5. è¨ˆç®—å…©é»ç¶“ç·¯åº¦è·é›¢ (Haversine formula) - ç”¨æ–¼å°‹æ‰¾æœ€è¿‘ç¸£å¸‚
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾‘ km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI / 180); }

        // 6. è‡ªå‹•å®šä½åŠŸèƒ½
        async function performGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    resolve(null); // ç€è¦½å™¨ä¸æ”¯æ´ï¼Œå›å‚³ null ä½¿ç”¨é è¨­å€¼
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;
                        
                        // å°‹æ‰¾è·é›¢æœ€è¿‘çš„ç¸£å¸‚ä¸­å¿ƒ
                        let minDistance = Infinity;
                        let nearestLocation = null;

                        for (const [loc, coords] of Object.entries(LOCATION_COORDS)) {
                            const distance = getDistanceFromLatLonInKm(userLat, userLng, coords.lat, coords.lng);
                            if (distance < minDistance) {
                                minDistance = distance;
                                nearestLocation = loc;
                            }
                        }
                        console.log(`è‡ªå‹•å®šä½çµæœ: ${nearestLocation} (è·é›¢ç´„ ${minDistance.toFixed(1)}km)`);
                        resolve(nearestLocation);
                    },
                    (error) => {
                        console.warn("ç„¡æ³•å–å¾—ä½ç½®æ¬Šé™æˆ–å®šä½å¤±æ•—:", error.message);
                        resolve(null); // å®šä½å¤±æ•—ï¼Œå›å‚³ null ä½¿ç”¨é è¨­å€¼
                    },
                    { timeout: 5000, maximumAge: 600000 } // è¨­å®šè¶…æ™‚å’Œç·©å­˜
                );
            });
        }


        // ================= CORE LOGIC =================

        // æ¸²æŸ“ç•«é¢
        function renderUI(data) {
            const forecasts = data.forecasts;
            const current = forecasts[0]; // ç›®å‰æ™‚æ®µ
            const others = forecasts.slice(1); // æœªä¾†æ™‚æ®µ

            // 1. è¨ˆç®—å¹³å‡æº«åº¦
            const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2);
            
            // 2. æ¸²æŸ“ä¸»å„€è¡¨ç›¤ (Current Weather)
            const mainIconClass = getWeatherIconClass(current.weather);
            document.getElementById('currentWeather').innerHTML = `
                <div class="temp-circle neu-convex-circle">
                    <div class="main-icon"><i class="ph ${mainIconClass}"></i></div>
                    <div class="main-temp">${avgTemp}Â°</div>
                    <div class="weather-desc">${current.weather}</div>
                </div>
                <div class="temp-range">
                    ä»Šæ—¥æ°£æº« ${current.minTemp}Â° - ${current.maxTemp}Â°
                </div>
            `;

            // 3. æ¸²æŸ“è©³ç´°è³‡è¨Š (Detail Grid) - è™•ç†å¯èƒ½ç¼ºå¤±çš„è³‡æ–™
            // æ³¨æ„: CWA F-C0032-001 API å¯èƒ½ä¸åŒ…å«é¢¨é€Ÿ(WS)ï¼Œè‹¥ç„¡å‰‡é¡¯ç¤º N/A
            const windSpeedDisplay = current.windSpeed ? `${current.windSpeed} m/s` : "N/A";
            const rainProb = current.rain ? `${current.rain}%` : "0%";

            document.getElementById('currentDetails').innerHTML = `
                <div class="detail-item neu-flat">
                    <i class="ph ph-drop detail-icon icon-rain"></i>
                    <div class="detail-value">${rainProb}</div>
                    <div class="detail-label">é™é›¨æ©Ÿç‡</div>
                </div>
                <div class="detail-item neu-flat">
                    <i class="ph ph-wind detail-icon icon-wind"></i>
                    <div class="detail-value">${windSpeedDisplay}</div>
                    <div class="detail-label">é¢¨é€Ÿ</div>
                </div>
                <div class="detail-item neu-flat">
                    <i class="ph ph-t-shirt detail-icon icon-comfort"></i>
                    <div class="detail-value" style="font-size: 0.9rem;">${current.comfort || 'èˆ’é©'}</div>
                    <div class="detail-label">èˆ’é©åº¦</div>
                </div>
            `;

            // 4. æ¸²æŸ“ç¨å¾Œé å ± (Forecast Scroll)
            const forecastContainer = document.getElementById('forecastContainer');
            forecastContainer.innerHTML = ''; // æ¸…ç©º
            others.forEach(f => {
                const timeLabel = formatTimePeriod(f.startTime);
                const iconClass = getWeatherIconClass(f.weather);
                const rainText = f.rain ? `ğŸ’§${f.rain}%` : '';

                forecastContainer.innerHTML += `
                    <div class="forecast-card neu-flat">
                        <div class="forecast-time">${timeLabel}</div>
                        <i class="ph ${iconClass} forecast-icon"></i>
                        <div class="forecast-temp">${f.minTemp}Â°-${f.maxTemp}Â°</div>
                        <div style="font-size:0.75rem; color:var(--neu-text-secondary); margin-top:4px;">${rainText}</div>
                    </div>
                `;
            });
        }

        // æŠ“å– API è³‡æ–™
        async function fetchWeather(location) {
            // é¡¯ç¤º Loading State
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('mainContent').style.visibility = 'hidden';
            document.getElementById('errorState').style.display = 'none';

            try {
                const targetUrl = `${API_ENDPOINT}?location=${encodeURIComponent(location)}`;
                console.log("Fetching:", targetUrl);

                // äººç‚ºåŠ å…¥ä¸€é»å»¶é²ï¼Œè®“ Loading å‹•ç•«å±•ç¤ºä¸€ä¸‹ï¼Œé«”é©—æ¯”è¼ƒå¥½
                const delay = new Promise(resolve => setTimeout(resolve, 800));
                const fetchPromise = fetch(targetUrl).then(async res => {
                    const json = await res.json();
                    if (!res.ok) throw new Error(json.message || "API Error");
                    return json;
                });

                const [_, json] = await Promise.all([delay, fetchPromise]);

                if (json.success) {
                    renderUI(json.data);
                    // æˆåŠŸå¾Œé¡¯ç¤ºä¸»ç•«é¢
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('mainContent').style.visibility = 'visible';
                } else {
                    throw new Error(json.message || "Unknown Error");
                }

            } catch (e) {
                console.error(e);
                // é¡¯ç¤ºéŒ¯èª¤ç•«é¢
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.visibility = 'hidden';
                document.getElementById('errorState').style.display = 'flex';
                document.getElementById('errorMessage').textContent = e.message || "ç„¡æ³•å–å¾—è³‡æ–™";
            }
        }

        // æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
        async function initWeatherApp() {
            updateDateDisplay();
            populateDropdown();

            // å˜—è©¦è‡ªå‹•å®šä½
            const locatedCity = await performGeolocation();
            if (locatedCity) {
                currentLocation = locatedCity;
                // æ›´æ–°ä¸‹æ‹‰é¸å–®çš„é¡¯ç¤º
                document.getElementById('locationSelect').value = currentLocation;
            }

            // é–‹å§‹æŠ“å–è³‡æ–™
            fetchWeather(currentLocation);
        }

        // ================= SETUP =================
        document.addEventListener("DOMContentLoaded", () => {
            initWeatherApp();

            // åˆå§‹åŒ– Pull-to-Refresh
            PullToRefresh.init({
                mainElement: 'body',
                triggerElement: 'body',
                instructionsPullToRefresh: 'ä¸‹æ‹‰åˆ·æ–°æ°£è±¡',
                instructionsReleaseToRefresh: 'é‡‹æ”¾é–‹å§‹æ›´æ–°',
                instructionsRefreshing: 'æ›´æ–°ä¸­...',
                onRefresh: function() {
                    // é‡æ–°æŠ“å–ç•¶å‰é¸å®šåœ°é»çš„è³‡æ–™
                    return fetchWeather(currentLocation); 
                }
            });
        });

    </script>
</body>
</html>