<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>日常氣象</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* === 1. 霧感薰衣草配色 === */
            --bg-color: #EFEEE9;
            /* 米白陶土底 */

            /* 指定色票 */
            --text-main: #615585;
            /* 深紫灰 (主要文字) */
            --text-accent: #9B8CC9;
            /* 粉嫩紫 (強調色/Icon) */

            --text-light: #8b92a0;
            /* 淺灰 (次要資訊) */

            /* 陰影系統 (保持暖調) */
            --shadow-light: #FFFFFF;
            --shadow-dark: #D4D0C5;

            --radius-box: 24px;
            --radius-btn: 18px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* === 擬物化工具類 === */

        .clay-box {
            background: var(--bg-color);
            border-radius: var(--radius-btn);
            box-shadow:
                5px 5px 13px var(--shadow-dark),
                -2px -3px 10px var(--shadow-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .clay-box:active {
            box-shadow:
                inset 4px 4px 8px var(--shadow-dark),
                inset -4px -4px 8px var(--shadow-light);
            transform: scale(0.98);
        }

        .clay-inset {
            background: var(--bg-color);
            border-radius: 50px;
            box-shadow:
                inset 4px 4px 8px var(--shadow-dark),
                inset -4px -4px 8px var(--shadow-light);
        }

        /* === 版面配置 === */
        .app-container {
            width: 100%;
            max-width: 420px;
            padding: 20px 30px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 2. Header */
        .header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding-top: 15px;
            margin-bottom: 30px;
        }

        .location-wrapper {
            position: relative;
            z-index: 10;
            min-width: 140px;
        }

        .location-select {
            appearance: none;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-main);
            padding: 10px 35px 10px 20px;
            cursor: pointer;
            width: 100%;
        }

        .location-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-accent);
            pointer-events: none;
            font-weight: bold;
        }

        /* 3. Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .status-item {
            aspect-ratio: 1/1;
            padding: 10px;
        }

        .status-icon {
            font-size: 1.8rem;
            color: var(--text-accent);
            margin-bottom: 5px;
        }

        .status-label {
            font-size: 0.8rem;
            color: var(--text-light);
            font-weight: 700;
        }

        /* 4. Main Pebble (鵝卵石造型) */
        .dial-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            position: relative;
            padding: 20px 0;
        }

        .weather-desc-title {
            font-size: 1.4rem;
            color: var(--text-main);
            font-weight: 800;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 不規則鵝卵石背景 */
        .pebble-shape {
            width: 260px;
            height: 260px;
            background: var(--bg-color);
            /* 關鍵：不規則圓角生成鵝卵石形狀 */
            border-radius: 30% 75% 42% 69% / 55% 45% 55% 45%;
            box-shadow:
                10px 10px 24px var(--shadow-dark),
                -10px -10px 24px var(--shadow-light);

            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;

            /* 讓它有一點微微的呼吸動態感 */
            animation: float 10s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                border-radius: 30% 75% 42% 69% / 55% 45% 55% 45%;
            }

            50% {
                border-radius: 54% 46% 58% 42% / 35% 45% 35% 55%;
            }

            100% {
                border-radius: 30% 75% 42% 69% / 55% 45% 55% 45%;
            }
        }

        /* 內部稍微凹陷一點增加層次感，或者直接放內容 */
        .pebble-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .main-temp {
            font-size: 4.5rem;
            font-weight: 700;
            color: var(--text-main);
            line-height: 1;
            letter-spacing: -2px;
            margin-left: 10px;
            /* 視覺平衡 */
        }

        .main-unit {
            font-size: 1.2rem;
            color: var(--text-accent);
            font-weight: 700;
            margin-top: -5px;
        }

        .bottom-status {
            margin-top: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-accent);
            font-weight: 700;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.3);
            /* 微微的底 */
            padding: 8px 16px;
            border-radius: 20px;
        }

        /* 5. Forecast List */
        .forecast-container {
            margin-top: 10px;
            margin-bottom: 10px;
            width: 100%;
        }

        .scroll-wrapper {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 15px 5px 25px 5px;
            /* 增加底部 padding 給陰影 */
            scrollbar-width: none;
        }

        .scroll-wrapper::-webkit-scrollbar {
            display: none;
        }

        .forecast-card {
            min-width: 130px;
            padding: 15px 10px;
            flex-shrink: 0;
            border-radius: 20px;
        }

        .fc-time {
            font-size: 0.85rem;
            color: var(--text-main);
            font-weight: 700;
            margin-bottom: 5px;
        }

        .fc-temp {
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-main);
            margin-top: 5px;
        }

        .fc-rain {
            font-size: 0.75rem;
            color: var(--text-accent);
            margin-top: 5px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s;
        }

        @keyframes loadingIcon {
            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>

<body>

    <div id="loadingOverlay" class="loading-overlay">
        <i class="ph ph-rainbow-cloud"
            style="font-size: 3rem; color: var(--text-accent); animation: loadingIcon 2s ease-in-out infinite;"></i>
        <p style="margin-top: 15px; font-weight: 700; color: var(--text-main);">正在觀測雲的流動...</p>
    </div>

    <div class="app-container">

        <header class="header">
            <div class="location-wrapper clay-inset">
                <select id="locationSelect" class="location-select">
                </select>
                <i class="ph ph-caret-down location-icon"></i>
            </div>
        </header>

        <section class="status-grid">
            <div class="status-item clay-box">
                <i class="ph ph-drop status-icon"></i>
                <span class="status-label" id="rainVal">--%</span>
            </div>
            <div class="status-item clay-box">
                <i class="ph ph-person-simple-walk status-icon"></i>
                <span class="status-label" id="comfortVal">--</span>
            </div>
            <div class="status-item clay-box">
                <i class="ph ph-calendar-heart status-icon"></i>
                <span class="status-label" id="dateVal">--/--</span>
            </div>
        </section>

        <section class="dial-container">
            <div class="weather-desc-title">
                <i id="mainIcon" class="ph ph-sun" style="color: var(--text-accent); font-size: 1.8rem;"></i>
                <span id="weatherDesc">載入中</span>
            </div>

            <div class="pebble-shape">
                <div class="pebble-content">
                    <span id="mainTemp" class="main-temp">--</span>
                    <!-- <span class="main-unit">攝氏溫度</span> -->
                </div>
            </div>

            <div class="bottom-status">
                <i class="ph ph-thermometer-simple"></i>
                <span id="tempRange">--° ~ --°</span>
            </div>
        </section>

        <section class="forecast-container">
            <h4
                style="font-size: 1.1rem; color: var(--text-light); margin-bottom: 15px; margin-left: 5px; font-weight: 700;">
                稍後預報</h4>
            <div class="scroll-wrapper" id="forecastList">
            </div>
        </section>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/pulltorefreshjs@0.1.22/dist/index.umd.min.js"></script>

    <script>
        // ================= CONFIG =================
        // TODO: 填入 Zeabur 後端網址
        const API_BASE_URL = "https://hex-weather-vibecoding.zeabur.app";
        const API_ENDPOINT = `${API_BASE_URL}/api/weather`;

        const TAIWAN_LOCATIONS = [
            "基隆市", "臺北市", "新北市", "桃園市", "新竹市", "新竹縣", "苗栗縣", "臺中市",
            "彰化縣", "南投縣", "雲林縣", "嘉義市", "嘉義縣", "臺南市", "高雄市", "屏東縣",
            "宜蘭縣", "花蓮縣", "臺東縣", "澎湖縣", "金門縣", "連江縣"
        ];

        // 簡易座標 (用於自動定位)
        const LOCATION_COORDS = {
            "基隆市": { lat: 25.1316, lng: 121.7447 }, "臺北市": { lat: 25.0375, lng: 121.5637 },
            "新北市": { lat: 25.0124, lng: 121.4657 }, "桃園市": { lat: 24.9889, lng: 121.3135 },
            "新竹市": { lat: 24.8036, lng: 120.9686 }, "新竹縣": { lat: 24.8421, lng: 121.0135 },
            "苗栗縣": { lat: 24.5648, lng: 120.8207 }, "臺中市": { lat: 24.1618, lng: 120.6468 },
            "彰化縣": { lat: 24.0518, lng: 120.5161 }, "南投縣": { lat: 23.9028, lng: 120.6904 },
            "雲林縣": { lat: 23.7080, lng: 120.4313 }, "嘉義市": { lat: 23.4812, lng: 120.4535 },
            "嘉義縣": { lat: 23.5089, lng: 120.5846 }, "臺南市": { lat: 22.9977, lng: 120.2192 },
            "高雄市": { lat: 22.6237, lng: 120.3120 }, "屏東縣": { lat: 22.6697, lng: 120.4861 },
            "宜蘭縣": { lat: 24.7021, lng: 121.7377 }, "花蓮縣": { lat: 23.9914, lng: 121.6098 },
            "臺東縣": { lat: 22.7563, lng: 121.1427 }, "澎湖縣": { lat: 23.5697, lng: 119.5794 },
            "金門縣": { lat: 24.4493, lng: 118.3766 }, "連江縣": { lat: 26.1505, lng: 119.9265 }
        };

        let currentLocation = "臺北市";

        // ================= HELPER FUNCTIONS =================

        function getIcon(wx) {
            if (!wx) return "ph-question";
            if (wx.includes("雷")) return "ph-cloud-lightning";
            if (wx.includes("雨")) return "ph-cloud-rain";
            if (wx.includes("陰")) return "ph-cloud";
            if (wx.includes("多雲") && wx.includes("晴")) return "ph-cloud-sun";
            if (wx.includes("多雲")) return "ph-cloud";
            if (wx.includes("晴")) return "ph-sun";
            return "ph-sun-dim";
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI / 180); }

        async function performGeolocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) { resolve(null); return; }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;
                        let minDistance = Infinity;
                        let nearestLocation = null;
                        for (const [loc, coords] of Object.entries(LOCATION_COORDS)) {
                            const distance = getDistanceFromLatLonInKm(userLat, userLng, coords.lat, coords.lng);
                            if (distance < minDistance) { minDistance = distance; nearestLocation = loc; }
                        }
                        resolve(nearestLocation);
                    },
                    (err) => { console.warn(err); resolve(null); },
                    { timeout: 4000 }
                );
            });
        }

        // ================= UI FUNCTIONS =================

        function renderUI(data) {
            const current = data.forecasts[0];
            const avgTemp = Math.round((parseInt(current.minTemp) + parseInt(current.maxTemp)) / 2);

            // 1. Grid Info
            document.getElementById('rainVal').textContent = current.rain ? `${current.rain}%` : '0%';
            document.getElementById('comfortVal').textContent = current.comfort || '舒適';

            // 2. Main Pebble (鵝卵石)
            document.getElementById('mainTemp').textContent = avgTemp + '°';
            document.getElementById('weatherDesc').textContent = current.weather;
            document.getElementById('mainIcon').className = `ph ${getIcon(current.weather)}`;
            document.getElementById('tempRange').textContent = `${current.minTemp}° ~ ${current.maxTemp}°`;

            // 3. Forecast List
            const list = document.getElementById('forecastList');
            list.innerHTML = '';

            data.forecasts.slice(1).forEach(f => {
                const date = new Date(f.startTime);
                const hour = date.getHours();
                const today = new Date().getDate();

                let timeStr = "";
                if (date.getDate() !== today) timeStr += "明天";

                if (hour >= 5 && hour < 11) timeStr += "早晨";
                else if (hour >= 11 && hour < 14) timeStr += "中午";
                else if (hour >= 14 && hour < 18) timeStr += "下午";
                else if (hour >= 18 && hour < 23) timeStr += "晚上";
                else timeStr += "深夜";

                const popText = f.rain ? `${f.rain}%` : '0%';

                list.innerHTML += `
                    <div class="clay-box forecast-card">
                        <div class="fc-time">${timeStr}</div>
                        <i class="ph ${getIcon(f.weather)}" style="font-size: 1.8rem; color: var(--text-accent); margin: 6px 0;"></i>
                        <div class="fc-temp">${f.minTemp}° - ${f.maxTemp}°</div>
                        <div class="fc-rain"><i class="ph-fill ph-drop"></i> ${popText}</div>
                    </div>
                `;
            });
        }

        async function fetchWeather(loc) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.opacity = '1';
            overlay.style.display = 'flex';

            try {
                const res = await fetch(`${API_ENDPOINT}?location=${loc}`);
                const json = await res.json();
                await new Promise(r => setTimeout(r, 600)); // 體驗優化：稍微停留

                if (json.success) {
                    renderUI(json.data);
                } else {
                    alert("資料讀取錯誤: " + json.message);
                }
            } catch (e) {
                console.error(e);
            } finally {
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 500);
            }
        }

        async function initApp() {
            // 1. 下拉選單
            const select = document.getElementById('locationSelect');
            TAIWAN_LOCATIONS.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc;
                opt.textContent = loc;
                select.appendChild(opt);
            });

            select.addEventListener('change', (e) => {
                currentLocation = e.target.value;
                fetchWeather(currentLocation);
            });

            // 2. 日期
            const now = new Date();
            const days = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            document.getElementById('dateVal').textContent = `${now.getMonth() + 1}/${now.getDate()} ${days[now.getDay()]}`;

            // 3. 定位
            select.value = currentLocation; // 預設
            const locatedCity = await performGeolocation();
            if (locatedCity) {
                currentLocation = locatedCity;
                select.value = currentLocation;
            }

            fetchWeather(currentLocation);
        }

        // Pull to refresh
        PullToRefresh.init({
            mainElement: 'body',
            onRefresh: function () { return fetchWeather(currentLocation); }
        });

        document.addEventListener("DOMContentLoaded", initApp);
    </script>
</body>

</html>